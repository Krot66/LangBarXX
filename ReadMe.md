[*Ветка форума Ru.Board*](http://forum.ru-board.com/topic.cgi?forum=5&topic=50256#1  "28.06.2019  21:32")

**LangBar++** - *индикация раскладки у курсора и ее исправление в набранном тексте*

Представляет собобой замену обычной языковой панели, индикатор языка ввода возле текстового курсора и средство исправления раскладки введенного текста - замену Punto Switcher для тех, кто в силу ряда причин не может пользоваться автоматическим переключением, а его возможности ручного исправления кажутся неудовлетворительными.

Возможности:

- Иконка в трее настраиваемых пропорций в виде флага с отрисовкой на ней состояния кнопок NumLock и ScrollLock
- Флажок раскладки около текстового курсора с настраиваемым размером, положением и прозрачностью, практически во всех приложениях
- Иконка и флажок генерируются из png-файлов, которые легко заменить вручную. Отрисовка иконок и флажков возможна для любых раскладок клавиатуры
- Ручное исправление раскладки набранного или выделенного текста. В отличии от Punto Switcher, происходит не мгновенное выделение последнего слова, а выделение набранных слов одно за другим слов с небольшой задержкой, так что и печатая не отрывая глаз от клавиатуры можно потом исправить все
- Возможность быстрого использования посимвольного выделения, необходимого, например, в программировании, где с выделением по словам вы, скорее всего, затрете лишнее и все придется набирать с начала
- Преобразование регистра (в заглавные буквы, строчные, заглавные первые или его инверсия), а также транслитерации с использованием того же  механизма выделения или выделенного вручную
- Поддержка FAR, ConEmu и командной строки; ограниченная (не отображается флажок) терминала Windows 11
- Настройка клавиш CapsLock, NumLock, ScrollLock

Программа адаптирована к использованию на виртуальных машинах и отличается низким потреблением системных  ресурсов. Может использоваться в качестве индикатора раскладки для слабовидящих.

Идет в одном исполняемом файле, осуществляющем установку и распаковку портативной версии.

**Операционная система**: Windows XP - 11

[TOC]

### Флажок раскладки и его настройка

<img src="ReadMe.assets/ReadMe1.gif" alt="ReadMe2" style="zoom:67%;" />

Отражается на полях текстового ввода, т. е. там, где имеется текстовый курсор. Имеется возможность менять относительное положение флажка мышью или масштабировать его колесиком, все с зажатым *Shift*. Можно менять прозрачность флажка прокручивая над ним колесико с зажатым *Alt* (*Alt+средняя кнопка* - значок непрозрачен). Настройки флажка всегда можно сбросить щелкнув по значку средней кнопкой мыши с зажатым *Shift*.

> Если у вас плохое зрение, можно разместить увеличенный флажок ниже кусора, где он не будет мешать. Единственным "но" данного метода является то, что при использовании горизонтального курсора, как в командной строке, флажок будет смещаться ниже

Пункт меню *Настройка флажка* предназначен для быстрой настройки его на ноутбуках и планшетах, где мышь отсутствует:

<img src="ReadMe.assets/ReadMe6.png" alt="ReadMe6" style="zoom:67%;" />

Состояние *CapsLock* отображается на флажке в виде голубой тени, хорошо заметной на светлом и темном фоне. 

> Значок можно всегда быстро выключить или включить одновременным нажатием левого и правого *Shift*

### Значок в трее, состояние NumLock и ScrollLock

Однократное нажатие на флажок или иконку в трее левой кнопкой мыши меняет раскладку. Сосотояние *NumLock* и *ScrollLock* отображается в виде двух цветных глаз на иконке в трее, флажок на которой при этом смещается вниз. Если вы привыкли работать с включенным NumLock, можно отметить в настройках пункт "Включен по умолчанию". В этом случае включение *NumLock* будет соответствовать неизменной иконке, и клавиша будет автоматически нажиматься при запуске программы.

### Исправление раскладки

<img src="ReadMe.assets/ReadMe2.gif" alt="ReadMe2" style="zoom:67%;" />

Преобразование текста производится нажатием кнопки *Pause/Break* или правым щелчком по флажку индикатора раскладки. Причем конвертировать возможно не только последнее набранное слово: если оставить на короткое время клавишу зажатой, будет выделено и преобразовано предыдущее, если только не производилось переключение раскладки, манипуляции мышью и нажатия нетекстовых клавиш. Тем же способом можно конвертировать и выделенный текст. Оба вида работают при наборе текста внутри строки. 

> Преобразование выделенного текста производится применительно к текущей раскладке. Т. е. Чтобы конвертировать русский текст в английский требуется, чтобы текущая раскладка была русской, что сделано для отсутствия путаницы при наличии более чем двух раскладок

<img src="ReadMe.assets/ReadMe3.gif" alt="ReadMe3" style="zoom:67%;" />

Преобразование работает в FAR, ConEmu, командной строке и терминале Windows 11, при этом из-за особенностей программ происходит забивание символов вместо их выделения. Можно всегда использовать этот абсолютно совместимый способ, например, в очень старых приложениях, с помощью сочетания *Shift+Backspace* вместо *Pause*.

#### Посимвольное выделение

<img src="ReadMe.assets/ReadMe4.gif" alt="ReadMe4" style="zoom:67%;" />

Помимо быстрого выделения "по словам", программа предусматривает возможность посимволного выделения (включаемого в соответствующем пункте настроек), полезного, например, в программировании, когда вводятся текстовые значения функций. Для этого сначала посылается короткое нажатие клавиши Pause; при последующем ее нажатии будет происходить посисмволное выделение набранного текста, пока клавиша нажата, и преобразование при ее отпускании. 

> Соответственно, при отсутствии отпускания будет производиться обычное выделение по словам, только начинающееся после небольшой задержки. 

Это работает и в случае использования *Shift+Backspace* - в этом случае *Shift* остается зажатым, а производится быстрый клик и зажатие Backspace.

Возможно и комбинированное выделение: первое слово или несколько слов выделяется длинным нажатием клавиши, затем отпускание клавиши и повторное нажатие с посимвольным выделением. В случае прерванного выделения по словам до преобразования будет небольшая задержка (смотри ниже). Можно избежать ее, отметив опцию *Только с начала*.

Преобразование текста всегда производится после отпускания клавиши!

#### Настройка задержек выделения

Поскольку способности к печати и разбитость клавиатуры у всех разная,  в программу зашиты некие усредненные и общеприемлемые величины задержек, но сделано возможным корректировать их вручную в графическом интерфейсе, вызываемом из меню настроек:

<img src="ReadMe.assets/ReadMe5.png" alt="ReadMe5" style="zoom: 50%;" />

Здесь:

- Интервал выделения по словам - промежуток времени, который программа ждет прежде, чем выделить следующее слово
- Ожидание отпускания клавиши - время, которое программа ждет отпускания клавиши (посимвольное выделение) до начала выделения по словам
- Интервал посимвольного выделения - интервал выделения символов при посимвольном выделении

В случае перехода с выделения по словам на посимвольное выделение, программа ждет половину значения последней задержки отпускания клавиши, и еще столько же ее повторного нажатия.

### Исправление регистра набранного текста

Производится подобно исправлению раскладки, настройки выделения действуют и здесь. Сочетания действуют и для выделенного текста. Для посимвольного выделения надо зажимать правый Ctrl и манипулировать основной клавишей.
Горячие клавиши:

- `Правый Ctrl+=` - инверсия регистра
- `Правый Ctrl+-` - в нижний регистр
- `Правый Ctrl+0` - в верхний регистр
- `Правый Ctrl+9` - первые заглавные

В настройках есть опция использования CapsLock только в качестве клавиши инверсии регистра, но еще есть и возможность сохранить при этом ее основной функционал (пункт *То же и инверсия регистра*). При этом основной функционал клавиши сохраняется, а выделение или преобразование выделенного текста начинаются после небольшой (0.3 c) задержки, если посимвольное выделение выключено.

Как и в случае исправления раскладки, преобразование производится после отпускания клавиши. После всех изменений регистра CapsLock находится в выключенном состоянии. Преобразование выделенного текста в случае включенного посимвольного выделения требует небольшой задержки клавиш. Изменения регистра производятся при любых раскладках клавиатуры.

### Транслитерация текста

Возможна транслитерация набранного и выделенного текста. Работает по тем же принципам, что и исправление раскладки и изменение регистра. Используется "стандартная таблица" транслитерации (ГОСТ 7.79-2000).

Для этого используется сочетание:  `Правый Ctrl+]`.

### Обработка больших фрагментов текста

Исправленный текст посылается с помощью виртуальных нажатий клавиш, чего совершенно достаточно в обычном случае, но не приемлемо для значительных кусков выделенного текста. В конфигурационном файле есть параметр *Max_send*, определяющий число знаков, при превышении которого происходит обычная вставка текста. Его можно отредактировать выйдя из программы.

### Особенности работы в браузерах

Современные браузеры не являются стандартным приложением Windows - по сути, это большая веб-страница, на которой нарисован интерфейс и ее содержимое. Получить положение курсора в ней можно (и то не всегда), получить же положение полос прокрутки невозможно в принципе. Поэтому при прокрутке мышью, тачпадом или масштабировании страницы флажок начинает "плыть", уходя от положения курсора. Чтобы исправить это, в программе сделано так: флажок прячется после двух прокруток и восстанавливает позицию при нажатии левой кнопки мыши, курсорных клавиш или текстовом вводе. 

Поддерживаются следующие браузеры: 

- Firefox Quantum (57+) и браузеры на его основе
- Chrome и хромоклоны (Edge, Opera, Maxthon, Vivaldi, Brave, SlimJet и др., плюс приложения Google Electron)
- "Старики" Internet Explorer и Opera Presto

### Работа с консолью, FAR, ConEmu и терминалом Windows 11

Автоматически производится забивание символов вместо выделения при использовании всех горячих клавиш. Флажок в командной строке и FAR на Windows 10-11  появляется только при включении режима старой командной строки  (*Свойства - Настройки - Использовать прежнюю версию консоли*). Для исправления текста нужен перезапуск программы! Отображение флажка в терминале Windows 11 невозможно, по крайней мере сейчас, в остальном все работает так же, как и в командной строке. ConEmu является наиболее беспроблемным инструментом на всех осях, позволяющим преобразовывать и выделенный с помощью клавиатуры текст.

### Использование на виртуальных машинах

Программа сделана так, что при запуске VirtualBox или VMware Player запущенная на хосте версия автоматически отключается и не препятствует работе программы, запущенной на виртуальной машине. На VMware Player работают все сочетания клавиш программы, на VirtualBox можно использовать сочетание Shift+Backspace для исправления раскладки, CapsLock для инверсии регистра, исправления или переключения раскладки.

### Флажки других раскладок, смена имеющихся, самостоятельная настройка

Если программа не находит флажка для вашей текущей раскладки в каталоге *flags*, эта раскладка в трее и на флажке будет отображаться в виде синего вопросительного знака (файл *flags\00.png*). Файл должен соответствовать короткому имени раскладки в [Microsoft Windows LCID List](https://www.ryadel.com/en/microsoft-windows-lcid-list-decimal-and-hex-all-locale-codes-ids/). Лезть в документацию не нужно - достаточно использовать пункт меню *Файл флажка* - он сообщит, каким должно быть назавание. Можно использовать имеющийся в каталоге *flags* архив с флажками или найти нужное где то еще, переименовать как требуется, поместить в каталог *flags*, и, собственно, все - работать начнет сразу же.

Общие требования к файлам флажков:

- Формат - png
- Небольшой размер, обработка которого не влияет на ресурсы компьютера (штатные флажки имеют размер ~64 px)
- Отсутствие прозрачных полей, почти всегда имеющихся у выложенных в сети флажков (в флажках в архиве они удалены пакетной обработкой)
- Пропорции значка не имеют значения и меняются программой

Кроме того:

- Нежелательно использование "объемных" флажков с тенями и пр. - простые, плоские значки в большинстве случаев выглядят лучше
- Предпочтительно использование упрощенных флажков без излишней деталировки; часто имеет смысл оставить центральную, значимую часть и обрезать остальное
- Небольшое размытие может улучшать отображение "сложных" флажков
- Крупные скругленные углы могут быть видны на подложке флажка при большом его размере

В каталоге *masks* есть три файла, накладывающихся на иконку в трее для обозначения состояния клавиш *NumLock* и *ScrollLock*. Назавания двух из них соответствуют этим кнопкам, еще есть файл *NumScroll.png*, соответствующий случаю, когда отображение одной из кнопок отключено. Все файлы квадратного размера, что обязательно, и, большей частью, прозрачны. Их можно перерисовать заново или изменить размеры непрозрачной части, но заниматься этим стоит в основном в случае, если вы либо имеете высокий DPI системы, либо флаг страны в иконке вас вообще мало интересуют. 

Когда иконка меняется для отображения состояния кнопок, флаг смещается вниз чтобы остаться видимым и не быть полностью заслоненной масками. Это поведение можно изменить, поменяв параметр *Icon_Shift* в *LangBarXX.ini*. Значению `-1` будет соответствовать сдвиг иконки вверх, а `0` - ее неподвижность.

### Установка и обновление программы

Программа идет в одном установочном файле, откуда возможна ее инсталляция и создание переносной версии, в том числе с помощью приложенных батников тихой установки и распаковки portable. 

При необходимости добавления флажков, отсутвующих в инсталляторе программы, следует создать каталог flags в папке установщика и поместить в него требуемые png-файлы, которые будут добавленыв каталог flags программы, перезаписывая существующие при совпадении имен. Точно так же можно перенести каталог masks и файл настроек LangBarXX.ini.

> При обновлении программы или распаковке портативной версии в тот же каталог, имеющиеся папки flags и masks сохраняются с суффиксом '_old', добавленные файлы флажков остаются на месте.

В папке программы имеется файл *LB_WatchDog.exe* - демон, отслеживающий работу программы и перезапускающий ее при падении, что случается крайне редко, но чего полностью исключить невозможно. На системах старше XP он работает лишь при запуске программы "от админа", так что для его использования с включенным UAC требуется запуск программы из планировщика с административными привиллегиями.

### FAQ

*В. Как при необходимости быстро выделить вручную, в том числе познаково, и преобразовать текст с помощью клавиатуры?*
О. Зажав Shift левой курсорной клавишей выделить текст и не отпуская его нажать BackSpace.

*В. Как убрать ставший ненужным текстовый индикатор раскладки, чтобы он не занимал место на панели задач?*
О. Панель управления - Языки - Дополнительные настройки.

*В. Как отключить использование клавиши Pause программой, нужной мне в другом приложении?*
О. Выйти из программы и поставить в конфигурационном файле *LangBarXX.ini* значение параметра *Pause=0*

*В. Является ли портативная версия программы "silent", не оставляющей следов в системе?*
О. Да, пока не используется автозапуск.

*В. Как превратить установленную версию программы в портативную?* 
О. Достаточно скопировать каталог программы, удалить из него два файла деинсталлятора unins000.* и добавить пустой текстовый файл portable.dat (можно скопировать туда же конфигурационный файл LangBarXX.ini из %APPDATA%\LangBarXX для сохранения настроек).

*В. Иногда после выхода из спящего режима, флажок перестает реагировать на нажатия мыши или зависает - что с этим делать?*
О. Программа сделана так, что любое ручное переключение раскладки клавиатуры (по *Alt+Shift, Ctrl+Shift, Win+Space*) перезапускает ее основные потоки, поэтому достаточно простого переключения раскладки для исправления этого.

*В. Почему запущенный в песочнице (Sandboxie и пр.) браузер не отображает флажок?*
О. Взаимодействие браузера с операционной системой искусственно ограничено и получить позицию курсора невозможно.

*В. На Windows 10 в некоторых программах (AkelPad) флажок уплывает от курсора при наборе текста - что с этим делать?*
О. Скорее всего, это связано с масштабировании интерфейса свыше 100% в операционной системе. Следует попробовать задать режим совместимости для высоких разрешений в программе (Свойства ярлыка или файла - вкладка Совместимость). При этом интерфейс программы может и не выглядеть размытым!

*В. Как быстро заменить на LangBar++ имеющийся индикатор раскладки (Punto или другой) в Wim- или Iso-образе загрузочного дика?*
О. Переименовать исполняемый файл LangBarXX.exe требуемым образом (при нобходимости сохранения настроек - и LangBarXX.ini) и заменить им исходный, не забыв про папки и файлы программы. 

*В. Почему столько дрязг с отображением какого-то флажка, что должно быть чем-то простым и само собой разумеющимся в Windows?*
О. Данный вопрос решительно непостижим для автора программы…